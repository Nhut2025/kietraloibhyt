<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Ki·ªÉm tra BHYT n√¢ng cao (T·ª± l∆∞u danh m·ª•c)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f7f7f7; }
    h2 { color: #003366; }
    .error { color: red; }
    .success { color: green; }
    ul { margin-bottom: 20px; }
    button { margin: 5px; }
  </style>
</head>
<body>
  <h2>Ki·ªÉm tra BHYT n√¢ng cao: MA_MAY, MA_DICHVU, MA_CCHN, gi·ªù b√°c sƒ©</h2>
  <ol>
    <li><b>T·∫£i danh m·ª•c Excel</b> (ch·ª©a c·∫£ MA_MAY v√† DV c·∫ßn ki·ªÉm tra MA_MAY)<br><input type="file" id="excelFile" /></li>
    <li><b>T·∫£i file XML h·ªì s∆°</b><br><input type="file" id="xmlFiles" multiple /></li>
  </ol>
  <button onclick="exportToExcel()">üì§ Xu·∫•t l·ªói</button>
  <button onclick="exportSuccessFiles()">üì§ Xu·∫•t danh s√°ch file kh√¥ng l·ªói</button>
  <button onclick="clearDanhMuc()">üóë X√≥a danh m·ª•c ƒë√£ l∆∞u</button>
  <div id="resultArea"></div>

  <script>
    let dmMay = new Set();
    let dvPhaiKiemTraMaMay_MA = {};
    let dvPhaiKiemTraMaMay_TEN = new Set();
    let errorsToExport = [];
    let successFiles = [];

    window.addEventListener("DOMContentLoaded", () => {
      const dmMayStr = localStorage.getItem("DM_MA_MAY");
      if (dmMayStr) {
        dmMay = new Set(JSON.parse(dmMayStr));
        alert("‚úÖ ƒê√£ n·∫°p danh m·ª•c MA_MAY t·ª´ b·ªô nh·ªõ.");
      }

      const dvMaStr = localStorage.getItem("DM_DV_MA");
      if (dvMaStr) {
        dvPhaiKiemTraMaMay_MA = JSON.parse(dvMaStr);
      }

      const dvTenStr = localStorage.getItem("DM_DV_TEN");
      if (dvTenStr) {
        dvPhaiKiemTraMaMay_TEN = new Set(JSON.parse(dvTenStr));
      }
    });

    function normalizeVN(str) {
      return str?.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") || "";
    }

    function base64ToUtf8(base64Str) {
      const binaryString = atob(base64Str);
      const bytes = Uint8Array.from(binaryString, c => c.charCodeAt(0));
      const utf8decoder = new TextDecoder("utf-8");
      return utf8decoder.decode(bytes);
    }

    function getTagValue(node, tags) {
      for (const tag of tags) {
        const el = node.getElementsByTagName(tag)[0];
        if (el && el.textContent?.trim()) {
          return el.textContent.trim();
        }
      }
      return "";
    }

    function dvBatBuocMaMay(maDV, tenDV) {
      if (!maDV && !tenDV) return false;
      if (dvPhaiKiemTraMaMay_MA[maDV]) return true;
      if (dvPhaiKiemTraMaMay_TEN.has(normalizeVN(tenDV))) return true;
      return false;
    }

    document.getElementById("excelFile").addEventListener("change", function (e) {
      const reader = new FileReader();
      reader.onload = function (event) {
        const data = new Uint8Array(event.target.result);
        const wb = XLSX.read(data, { type: "array" });

        const sheetMaMay = wb.Sheets["MA_MAY"];
        if (sheetMaMay) {
          const rows = XLSX.utils.sheet_to_json(sheetMaMay);
          rows.forEach(r => {
            if (r.MA_MAY) dmMay.add(r.MA_MAY.toString().trim());
          });
          alert("‚úÖ ƒê√£ n·∫°p " + dmMay.size + " m√£ m√°y t·ª´ sheet MA_MAY.");
        } else {
          alert("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y sheet MA_MAY.");
        }

        const sheetDV = wb.Sheets["DV_CAN_KIEMTRA_MA_MAY"];
        if (sheetDV) {
          const rowsDV = XLSX.utils.sheet_to_json(sheetDV);
          rowsDV.forEach(r => {
            if (r.MA_DICHVU) {
              dvPhaiKiemTraMaMay_MA[r.MA_DICHVU.trim()] = true;
            }
            if (r.TEN_DICHVU) {
              dvPhaiKiemTraMaMay_TEN.add(normalizeVN(r.TEN_DICHVU.trim()));
            }
          });
          alert("‚úÖ ƒê√£ n·∫°p danh m·ª•c DV c·∫ßn ki·ªÉm tra m√£ m√°y.");
        } else {
          alert("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y sheet DV_CAN_KIEMTRA_MA_MAY.");
        }

        localStorage.setItem("DM_MA_MAY", JSON.stringify([...dmMay]));
        localStorage.setItem("DM_DV_MA", JSON.stringify(dvPhaiKiemTraMaMay_MA));
        localStorage.setItem("DM_DV_TEN", JSON.stringify([...dvPhaiKiemTraMaMay_TEN]));
        alert("‚úÖ Danh m·ª•c ƒë√£ ƒë∆∞·ª£c l∆∞u. L·∫ßn sau m·ªü kh√¥ng c·∫ßn t·∫£i Excel n·ªØa.");
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    });

    document.getElementById("xmlFiles").addEventListener("change", function (e) {
      if (
        dmMay.size === 0 &&
        Object.keys(dvPhaiKiemTraMaMay_MA).length === 0 &&
        dvPhaiKiemTraMaMay_TEN.size === 0
      ) {
        alert("‚ö†Ô∏è Ch∆∞a n·∫°p danh m·ª•c d·ªØ li·ªáu (MA_MAY ho·∫∑c DV c·∫ßn ki·ªÉm tra MA_MAY). Vui l√≤ng t·∫£i file Excel tr∆∞·ªõc.");
        return;
      }

      const files = e.target.files;
      const resultArea = document.getElementById("resultArea");
      resultArea.innerHTML = "";
      errorsToExport = [];
      successFiles = [];

      let filesProcessed = 0;

      [...files].forEach(file => {
        const reader = new FileReader();
        reader.onload = function (event) {
          try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(event.target.result, "text/xml");
            const fileHoSoNodes = xmlDoc.getElementsByTagName("FILEHOSO");

            for (const fileHoSo of fileHoSoNodes) {
              const noiDungNode = fileHoSo.getElementsByTagName("NOIDUNGFILE")[0];
              if (!noiDungNode) continue;

              const decoded = base64ToUtf8(noiDungNode.textContent.trim());
              const innerDoc = parser.parseFromString(decoded, "text/xml");
              const errors = [];

              const dvktNodes = [...innerDoc.getElementsByTagName("CHI_TIET_DVKT")];
              const ngayVao = innerDoc.getElementsByTagName("NGAY_VAO")?.[0]?.textContent?.trim();
              const ngayRa = innerDoc.getElementsByTagName("NGAY_RA")?.[0]?.textContent?.trim();

              const gioMap = new Map();

              dvktNodes.forEach((node, index) => {
                const maMay = getTagValue(node, ["MA_MAY"]);
                const maDV = getTagValue(node, ["MA_DICHVU", "MA_DICH_VU"]);
                const tenDV = getTagValue(node, ["TEN_DICHVU", "TEN_DICH_VU"]);
                const maBS = getTagValue(node, ["MA_CCHN", "MA_BAC_SI"]);
                const maVTYT = getTagValue(node, ["MA_VTYT", "MA_VAT_TU"]);
                const ngay = getTagValue(node, ["NGAY_YLENH"]);
                const gio = getTagValue(node, ["GIO"]);

                const key = `${maBS}_${ngay}_${gio}`;
                if (key && gio) {
                  gioMap.set(key, (gioMap.get(key) || 0) + 1);
                }

                if (dvBatBuocMaMay(maDV, tenDV)) {
                  if (!maMay || maMay === "0" || maMay === "000" || maMay === ".") {
                    errors.push(`‚ùå D√≤ng ${index + 1}: Thi·∫øu m√£ m√°y - DV: ${maDV} - ${tenDV}`);
                  } else if (maMay.length < 3) {
                    errors.push(`‚ùå D√≤ng ${index + 1}: M√£ m√°y '${maMay}' qu√° ng·∫Øn.`);
                  } else if (dmMay.size > 0 && !dmMay.has(maMay)) {
                    errors.push(`‚ùå D√≤ng ${index + 1}: M√£ m√°y '${maMay}' kh√¥ng c√≥ trong danh m·ª•c - DV: ${maDV} - ${tenDV}`);
                  }
                }

                if (!maDV && !maVTYT) {
                  errors.push(`‚ùå D√≤ng ${index + 1}: Thi·∫øu MA_DICHVU (kh√¥ng ph·∫£i v·∫≠t t∆∞) cho d·ªãch v·ª• '${tenDV}'.`);
                }

                if (!maBS) {
                  errors.push(`‚ùå D√≤ng ${index + 1}: Thi·∫øu MA_CCHN (b√°c sƒ©) cho d·ªãch v·ª• '${tenDV}'.`);
                }

                if (ngayVao && ngayRa && ngay) {
                  if (ngay < ngayVao || ngay > ngayRa) {
                    errors.push(`‚ùå D√≤ng ${index + 1}: Ng√†y y l·ªánh ${ngay} ngo√†i kho·∫£ng ƒëi·ªÅu tr·ªã (${ngayVao} - ${ngayRa}).`);
                  }
                }
              });

              for (const [key, count] of gioMap.entries()) {
                if (count > 1) {
                  const [bs, ngay, gio] = key.split("_");
                  errors.push(`‚ùå Tr√πng gi·ªù: B√°c sƒ© ${bs} th·ª±c hi·ªán nhi·ªÅu DV l√∫c ${gio} ng√†y ${ngay}`);
                }
              }

              if (ngayVao && ngayRa && ngayVao > ngayRa) {
                errors.push(`‚ùå Ng√†y ra vi·ªán tr∆∞·ªõc ng√†y v√†o vi·ªán (${ngayVao} ‚Üí ${ngayRa})`);
              } else if (ngayVao && ngayRa && ngayVao === ngayRa) {
                errors.push(`‚ö†Ô∏è S·ªë ng√†y ƒëi·ªÅu tr·ªã b·∫±ng 0 (ng√†y v√†o = ng√†y ra: ${ngayVao})`);
              }

              if (errors.length > 0) {
                resultArea.innerHTML += `<h4 class="error">‚ùå File ${file.name}</h4><ul>` +
                  errors.map(e => `<li>${e}</li>`).join('') + "</ul><hr/>";
                errorsToExport.push(...errors.map(e => `[${file.name}] ${e}`));
              } else {
                successFiles.push(file.name);
              }
            }

            filesProcessed++;
            if (filesProcessed === files.length) {
              if (successFiles.length > 0 && errorsToExport.length === 0) {
                resultArea.innerHTML = `<h4 class="success">‚úÖ T·∫•t c·∫£ ${successFiles.length} file ƒë·ªÅu kh√¥ng ph√°t hi·ªán l·ªói</h4>`;
              } else if (successFiles.length > 0) {
                resultArea.innerHTML += `<h4 class="success">‚úÖ C√≥ ${successFiles.length} file kh√¥ng ph√°t hi·ªán l·ªói</h4>`;
              }
            }
          } catch (ex) {
            resultArea.innerHTML += `<h4 class="error">‚ùå File ${file.name} l·ªói gi·∫£i m√£ ho·∫∑c ƒë·ªçc h·ªì s∆°! ${ex.message}</h4>`;
          }
        };
        reader.readAsText(file);
      });
    });

    function exportToExcel() {
      if (errorsToExport.length === 0) {
        alert("‚úÖ Kh√¥ng c√≥ l·ªói n√†o ƒë·ªÉ xu·∫•t.");
        return;
      }
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([["Danh s√°ch l·ªói"], ...errorsToExport.map(e => [e])]);
      XLSX.utils.book_append_sheet(wb, ws, "Loi");
      XLSX.writeFile(wb, "bao_cao_loi_bhxh_ma_may.xlsx");
    }

    function exportSuccessFiles() {
      if (successFiles.length === 0) {
        alert("‚ö†Ô∏è Kh√¥ng c√≥ file n√†o ƒë·∫°t.");
        return;
      }
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([["Danh s√°ch file kh√¥ng l·ªói"], ...successFiles.map(f => [f])]);
      XLSX.utils.book_append_sheet(wb, ws, "ThanhCong");
      XLSX.writeFile(wb, "bao_cao_file_khong_loi.xlsx");
    }

    function clearDanhMuc() {
      localStorage.removeItem("DM_MA_MAY");
      localStorage.removeItem("DM_DV_MA");
      localStorage.removeItem("DM_DV_TEN");
      alert("‚úÖ ƒê√£ x√≥a to√†n b·ªô danh m·ª•c ƒë√£ l∆∞u. H√£y t·∫£i file Excel m·ªõi n·∫øu mu·ªën ch·∫°y ti·∫øp.");
      location.reload();
    }
  </script>
</body>
</html>
